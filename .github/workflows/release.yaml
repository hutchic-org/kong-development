---
name: Release

on:  # yamllint disable-line rule:truthy
  pull_request:
  push:
    branches:
    - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      published: ${{ steps.release.outputs.published }}
      release-git-tag: ${{ steps.release.outputs.release-git-tag }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        submodules: true
        token: ${{ secrets.GH_TOKEN }}

    - name: Release
      id: release
      uses: ahmadnassri/action-semantic-release@v2.1.10
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  artifacts-linux-gnu:
    needs: release
    name: Create Release Artifacts
    strategy:
      matrix:
        architecture: [aarch64, x86_64]
        os: [{os: ubuntu, version: rolling, ostype: linux-gnu}, {os: ubuntu, version: 16.04, ostype: linux-gnu}, {os: debian, version: testing, ostype: linux-gnu},
          {os: debian, version: 10, ostype: linux-gnu}, {os: amazonlinux, version: 2, ostype: linux-gnu}, {os: amazonlinux, version: 2022, ostype: linux-gnu},
          {os: rhel, version: 8, ostype: linux-gnu}, {os: alpine, version: 3, ostype: linux-musl}]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        submodules: true
        token: ${{ secrets.GH_TOKEN }}

    - name: Log in to the Container registry
      uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - uses: docker/setup-qemu-action@v2

    - uses: docker/setup-buildx-action@v2

    - name: Set environment variables
      run: |
        echo "ARCHITECTURE=${{ matrix.architecture }}" >> $GITHUB_ENV
        echo "REGISTRY=ghcr.io" >> $GITHUB_ENV
        echo "OSTYPE=${{ matrix.os.ostype }}" >> $GITHUB_ENV
        echo "OPERATING_SYSTEM=${{ matrix.os.os }}" >> $GITHUB_ENV
        echo "OPERATING_SYSTEM_VERSION=${{ matrix.os.version }}" >> $GITHUB_ENV

    - name: Build, and Package
      run: make package

    - name: Docker meta
      if: ${{ needs.release.outputs.published == 'true' }}
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ghcr.io/hutchic-org/kong-development
        sep-tags: ' '
        flavor: |
          suffix=-${{ matrix.architecture }}-${{ matrix.ostype }}
        tags: |
          type=sha
          type=ref,event=branch
          type=semver,pattern={{version}},value=${{ needs.release.outputs.release-git-tag }}
          type=semver,pattern={{major}},value=${{ needs.release.outputs.release-git-tag }}

    - name: Retag and Push
      if: ${{ needs.release.outputs.published == 'true' }}
      run: |
        for tag in ${{ steps.meta.outputs.tags }}; do \
          docker tag ghcr.io/kong-development:build-$ARCHITECTURE-$OSTYPE $tag && \
          docker push $tag; \
        done

    - name: Archive the package
      if: ${{ needs.release.outputs.published == 'true' }}
      run: |
        tar -C package -czvf ${{ matrix.architecture }}-${{ matrix.ostype }}.tar.gz .

    - name: Add Release Artifact to the Github Release
      if: ${{ needs.release.outputs.published == 'true' }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.release.outputs.release-git-tag }}
        files: ${{ matrix.architecture }}-${{ matrix.ostype }}.tar.gz
